name 'keyboard'
org 'akerl'

source(
  type: 'git',
  path: '.'
)

build do
  run 'arduino-cli core install keyboardio:avr arduino:avr keyboardio:gd32'
  kaleidoscope_dir = Dir.glob(File.expand_path('~/.arduino15/packages/keyboardio/hardware/avr/*/libraries/Kaleidoscope')).first
  run 'git config --global url."https://".insteadOf git://'
  run "make -C #{kaleidoscope_dir} setup"

  ['model01', 'model100'].each do |board|
    Dir.chdir(board) do
      run 'arduino-cli compile --output-dir ../output'
      cp "output/#{board}.ino.elf", "#{board}.elf"
      cp "output/#{board}.ino.hex", "#{board}.hex"
    end
  end
end

package(
  type: 'file',
  artifacts: [
      {
        source: 'model01.ino.with_bootloader.bin',
        name: 'model01.bin'
      },
      {
        source: 'model100.ino.bin',
        name: 'model100.bin'
      }
    ]
  end
)

test do
  # TODO: add tests
end
