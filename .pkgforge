name 'keyboard'
org 'akerl'

source(
  type: 'git',
  path: '.'
)

build do
  #dirname = tmpdir(:build).split('/').last
  run 'arduino-cli core install keyboardio:avr arduino:avr'
  kaleidoscope_dir = Dir.glob(File.expand_path('~/.arduino15/packages/keyboardio/hardware/avr/*/libraries/Kaleidoscope')).first
  run 'git config --global url."https://".insteadOf git://'
  run "make -C #{kaleidoscope_dir} setup"
  run 'make -f Makefile.upstream', 'KALEIDOSCOPE_DIR' => kaleidoscope_dir
  #run "touch #{dirname}.ino"
  #run 'arduino-cli compile --output-dir output'
  #cp "output/#{dirname}.ino.elf", 'keyboard.elf'
  #cp "output/#{dirname}.ino.hex", 'keyboard.hex'
end

package(
  type: 'file',
  artifacts: [
    {
      source: 'keyboard.hex',
      name: 'keyboard.hex'
    },
    {
      source: 'keyboard.elf',
      name: 'keyboard.elf'
    }
  ]
)

test do
  # TODO: add tests
end
